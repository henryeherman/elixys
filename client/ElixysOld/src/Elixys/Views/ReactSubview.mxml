<?xml version="1.0" encoding="utf-8"?>
<Views:SubviewBase xmlns:fx="http://ns.adobe.com/mxml/2009" xmlns:s="library://ns.adobe.com/flex/spark" xmlns:mx="library://ns.adobe.com/flex/mx"
		xmlns:Views="Elixys.Views.*" width="100%" height="100%" xmlns:Renderers="Elixys.Views.Renderers.*">
	<fx:Script>
		<![CDATA[
			import Elixys.Events.HTTPRequestEvent;
			import Elixys.HTTP.HTTPRequest;
			import Elixys.Objects.Component;
			import Elixys.Objects.ComponentReact;
			import Elixys.Objects.ReactorState;
			import Elixys.Objects.Reagent;
			import Elixys.Objects.State;
			import Elixys.Objects.StateSequence;
			
			import mx.controls.TextArea;
			import mx.events.FlexEvent;
			
			import spark.events.IndexChangeEvent;

			/***
			 * Member functions
			 **/
			
			// Called when the state arrives from the server
			public override function UpdateState(pState:State):void
			{
				// Handle according to our view mode
				if (m_sViewMode == SubviewBase.RUNMODE)
				{
					// Set the status and video stream
					_runStatusText.text = pState.ServerState().RunState().Status();
					if (m_pComponentReact != null)
					{
						m_pElixysMain.SetVideo(pState, m_pComponentReact.Reactor, _runVideo);
					}
					
					// Update the timer buttons
					UpdateButtons(_timerButtons, pState.ServerState().RunState().TimerButtons(), CreateButtonCallback);
				}
			}

			// Called when component details arrive from the server
			public override function UpdateComponent(pComponent:Component):void
			{
				// Remember the component
				m_pComponentReact = new ComponentReact(null, pComponent);
				
				// Handle according to our view mode
				if (m_sViewMode == SubviewBase.VIEWMODE)
				{
					// Set the name and format the output text
					_viewComponentName.text = m_pComponentReact.Name;
					_outputText.text = "Move reactor " + m_pComponentReact.Reactor + " to reaction position " + m_pComponentReact.Position +
						" and heat to " + m_pComponentReact.ReactionTemperature + " \u00B0C.\n\n";
					_outputText.text += "Hold for " + m_pComponentReact.Duration + " seconds while stirring at " + 
						m_pComponentReact.StirSpeed + ".\n\n";
					_outputText.text += "Cool to " + m_pComponentReact.FinalTemperature + " \u00B0C";
					if (m_pComponentReact.CoolingDelay != 0)
					{
						_outputText.text += " and continue cooling for another " + m_pComponentReact.CoolingDelay + " seconds.";
					}
					else
					{
						_outputText.text += ".";
					}
				}
				else if (m_sViewMode == SubviewBase.EDITMODE)
				{
					// Set the name
					_editComponentName.text = m_pComponentReact.Name;

					// Fill the reactor and position combo boxes
					UpdateEnumNumberComboBox(m_pComponentReact.ReactorValidation, _editReactorCombo, m_pComponentReact.Reactor.toString());
					UpdateEnumNumberComboBox(m_pComponentReact.PositionValidation, _editPositionCombo, m_pComponentReact.Position);
					
					// Set all evaporation variables except the one the user is editing
					if (m_pKeyboardFocusTextArea != _editDuration)
					{
						_editDuration.text = m_pComponentReact.Duration.toString();
					}
					if (m_pKeyboardFocusTextArea != _editReactionTemperature)
					{
						_editReactionTemperature.text = m_pComponentReact.ReactionTemperature.toString();
					}
					if (m_pKeyboardFocusTextArea != _editFinalTemperature)
					{
						_editFinalTemperature.text = m_pComponentReact.FinalTemperature.toString();
					}
					if (m_pKeyboardFocusTextArea != _editCoolingDelay)
					{
						_editCoolingDelay.text = m_pComponentReact.CoolingDelay.toString();
					}
					if (m_pKeyboardFocusTextArea != _editStirSpeed)
					{
						_editStirSpeed.text = m_pComponentReact.StirSpeed.toString();
					}
				}
				else if (m_sViewMode == SubviewBase.RUNMODE)
				{
					// Removing the following line causes a compile error for reasons I don't understand
					var pElixysMain:ElixysMain = null;

					// Set the name and format the output text
					_runComponentName.text = m_pComponentReact.Name;
					_runOutputText1.text = "Reacting reactor " + m_pComponentReact.Reactor + " in position " + m_pComponentReact.Position +
						" at " + m_pComponentReact.ReactionTemperature + " \u00B0C for " + m_pComponentReact.Duration +
						" seconds.";
					_runOutputText2.text = "Stirring at " + m_pComponentReact.StirSpeed + " and cooling to " + m_pComponentReact.FinalTemperature +
						" \u00B0C";
					if (m_pComponentReact.CoolingDelay != 0)
					{
						_runOutputText2.text += " with an additional delay of " + m_pComponentReact.CoolingDelay + " seconds.";
					}
					else
					{
						_runOutputText2.text += ".";
					}
					_runVideoText.text = "Reactor " + m_pComponentReact.Reactor;
				}
			}

			/***
			 * Message handlers
			 **/
			
			// Called when creation is complete
			protected override function OnCreationComplete(event:FlexEvent):void
			{
				// Call the base implementation
				super.OnCreationComplete(event);

				// Set the base class variables
				m_pViewGroup = _viewGroup;
				m_pEditGroup = _editGroup;
				m_pRunGroup = _runGroup;
				
				// Set our view mode
				SetViewMode(m_sViewMode)
			}
			
			// Called when the user changes the selection of the combo box
			protected function OnReactorChange(event:IndexChangeEvent):void
			{
				// Update our component
				m_pComponentReact.Reactor = parseInt(_editReactorCombo.selectedItem as String);
				
				// Pass the request to the server
				var nSequenceID:uint = m_pElixysMain.GetActiveSequenceView().GetSequenceID();
				m_pElixysMain.GetActiveSequenceView().DoPost(m_pComponentReact, "sequence/" + nSequenceID + "/component/" + m_pComponentReact.ID);
			}
			protected function OnPositionChange(event:IndexChangeEvent):void
			{
				// Update our component
				m_pComponentReact.Position = _editPositionCombo.selectedItem as String;
				
				// Pass the request to the server
				var nSequenceID:uint = m_pElixysMain.GetActiveSequenceView().GetSequenceID();
				m_pElixysMain.GetActiveSequenceView().DoPost(m_pComponentReact, "sequence/" + nSequenceID + "/component/" + m_pComponentReact.ID);
			}
			
			// Called when the user changes the text in one of our input fields
			protected override function OnTextValueChanged(pFocusTarget:TextArea):void
			{
				// Update our component
				if (m_pKeyboardFocusTextArea == _editDuration)
				{
					m_pComponentReact.Duration = parseInt(_editDuration.text);
				}
				if (m_pKeyboardFocusTextArea == _editReactionTemperature)
				{
					m_pComponentReact.ReactionTemperature = parseFloat(_editReactionTemperature.text);
				}
				if (m_pKeyboardFocusTextArea == _editFinalTemperature)
				{
					m_pComponentReact.FinalTemperature = parseFloat(_editFinalTemperature.text);
				}
				if (m_pKeyboardFocusTextArea == _editCoolingDelay)
				{
					m_pComponentReact.CoolingDelay = parseFloat(_editCoolingDelay.text);
				}
				if (m_pKeyboardFocusTextArea == _editStirSpeed)
				{
					m_pComponentReact.StirSpeed = parseInt(_editStirSpeed.text);
				}
				
				// Save the component to the server
				var nSequenceID:uint = m_pElixysMain.GetActiveSequenceView().GetSequenceID();
				m_pElixysMain.GetActiveSequenceView().DoPost(m_pComponentReact, "sequence/" + nSequenceID + "/component/" + m_pComponentReact.ID);
			}

			/***
			 * Member variables
			 **/
			
			// Component
			private var m_pComponentReact:ComponentReact;
		]]>
	</fx:Script>
	
	<s:VGroup width="100%" height="100%">
		<s:VGroup id="_viewGroup" visible="false" includeInLayout="false" width="100%" height="100%">
			<s:HGroup width="100%" horizontalAlign="center">
				<s:Label id="_viewComponentName" styleName="TextLarge" />
			</s:HGroup>
			<s:Spacer height="10" />
			<s:VGroup horizontalAlign="center" verticalAlign="middle" horizontalCenter="0" verticalCenter="0" width="100%" height="100%">
				<mx:Text id="_outputText" styleName="TextMedium" width="80%" />		
			</s:VGroup>
		</s:VGroup>
		<s:VGroup id="_editGroup" visible="false" includeInLayout="false" width="100%" height="100%">
			<s:HGroup width="100%" horizontalAlign="center">
				<s:Label id="_editComponentName" styleName="TextLarge" />
			</s:HGroup>
			<s:Spacer height="10" />
			<s:VGroup horizontalAlign="center" verticalAlign="middle" horizontalCenter="0" verticalCenter="0" width="100%" height="100%">
				<s:VGroup gap="15" width="100%" height="100%">
					<s:Spacer height="100%" />
					<s:VGroup width="100%">
						<s:HGroup verticalAlign="middle" gap="15" width="80%">
							<s:HGroup horizontalAlign="right" width="50%">
								<s:Label text="Reactor:" styleName="TextMedium" />
							</s:HGroup>
							<s:HGroup horizontalAlign="left" width="50%">
								<s:ComboBox id="_editReactorCombo" change="OnReactorChange(event)" styleName="TextMedium" width="100%" />
							</s:HGroup>
						</s:HGroup>
						<s:HGroup verticalAlign="middle" gap="15" width="80%">
							<s:Spacer width="50%" />
							<s:HGroup horizontalAlign="left" width="50%">
								<s:Label styleName="FieldDescription" text="Reactor to be reacted"/>
							</s:HGroup>
						</s:HGroup>
					</s:VGroup>
					<s:VGroup width="100%">
						<s:HGroup verticalAlign="middle" gap="15" width="80%">
							<s:HGroup horizontalAlign="right" width="50%">
								<s:Label text="Temperature:" styleName="TextMedium" />
							</s:HGroup>
							<s:HGroup horizontalAlign="left" width="50%">
								<Renderers:AutoTextArea id="_editReactionTemperature" styleName="TextMedium" focusIn="OnTextFocusIn(event)"
														focusOut="OnTextFocusOut(event)" width="100%" />
							</s:HGroup>
						</s:HGroup>
						<s:HGroup verticalAlign="middle" gap="15" width="80%">
							<s:Spacer width="50%" />
							<s:HGroup horizontalAlign="left" width="50%">
								<s:Label styleName="FieldDescription" text="Reaction temperature in degrees Celsius"/>
							</s:HGroup>
						</s:HGroup>
					</s:VGroup>
					<s:VGroup width="100%">
						<s:HGroup verticalAlign="middle" gap="15" width="80%">
							<s:HGroup horizontalAlign="right" width="50%">
								<s:Label text="Time:" styleName="TextMedium" />
							</s:HGroup>
							<s:HGroup horizontalAlign="left" width="50%">
								<Renderers:AutoTextArea id="_editDuration" styleName="TextMedium" focusIn="OnTextFocusIn(event)"
														focusOut="OnTextFocusOut(event)" width="100%" />
							</s:HGroup>
						</s:HGroup>
						<s:HGroup verticalAlign="middle" gap="15" width="80%">
							<s:Spacer width="50%" />
							<s:HGroup horizontalAlign="left" width="50%">
								<s:Label styleName="FieldDescription" text="Duration of reaction in seconds"/>
							</s:HGroup>
						</s:HGroup>
					</s:VGroup>
					<s:VGroup width="100%">
						<s:HGroup verticalAlign="middle" gap="15" width="80%">
							<s:HGroup horizontalAlign="right" width="50%">
								<s:Label text="Final Temperature:" styleName="TextMedium" />
							</s:HGroup>
							<s:HGroup horizontalAlign="left" width="50%">
								<Renderers:AutoTextArea id="_editFinalTemperature" styleName="TextMedium" focusIn="OnTextFocusIn(event)"
														focusOut="OnTextFocusOut(event)" width="100%" />
							</s:HGroup>
						</s:HGroup>
						<s:HGroup verticalAlign="middle" gap="15" width="80%">
							<s:Spacer width="50%" />
							<s:HGroup horizontalAlign="left" width="50%">
								<s:Label styleName="FieldDescription" text="Final temperature in degrees Celsius"/>
							</s:HGroup>
						</s:HGroup>
					</s:VGroup>
					<s:VGroup width="100%">
						<s:HGroup verticalAlign="middle" gap="15" width="80%">
							<s:HGroup horizontalAlign="right" width="50%">
								<s:Label text="Cooling delay:" styleName="TextMedium" />
							</s:HGroup>
							<s:HGroup horizontalAlign="left" width="50%">
								<Renderers:AutoTextArea id="_editCoolingDelay" styleName="TextMedium" focusIn="OnTextFocusIn(event)"
														focusOut="OnTextFocusOut(event)" width="100%" />
							</s:HGroup>
						</s:HGroup>
						<s:HGroup verticalAlign="middle" gap="15" width="80%">
							<s:Spacer width="50%" />
							<s:HGroup horizontalAlign="left" width="50%">
								<s:Label styleName="FieldDescription" text="Additional cooling time in seconds"/>
							</s:HGroup>
						</s:HGroup>
					</s:VGroup>
					<s:VGroup width="100%">
						<s:HGroup verticalAlign="middle" gap="15" width="80%">
							<s:HGroup horizontalAlign="right" width="50%">
								<s:Label text="Position:" styleName="TextMedium" />
							</s:HGroup>
							<s:HGroup horizontalAlign="left" width="50%">
								<s:ComboBox id="_editPositionCombo" change="OnPositionChange(event)" styleName="TextMedium" width="100%" />
							</s:HGroup>
						</s:HGroup>
						<s:HGroup verticalAlign="middle" gap="15" width="80%">
							<s:Spacer width="50%" />
							<s:HGroup horizontalAlign="left" width="50%">
								<s:Label styleName="FieldDescription" text="Reaction position"/>
							</s:HGroup>
						</s:HGroup>
					</s:VGroup>
					<s:VGroup width="100%">
						<s:HGroup verticalAlign="middle" gap="15" width="80%">
							<s:HGroup horizontalAlign="right" width="50%">
								<s:Label text="Stir speed:" styleName="TextMedium" />
							</s:HGroup>
							<s:HGroup horizontalAlign="left" width="50%">
								<Renderers:AutoTextArea id="_editStirSpeed" styleName="TextMedium" focusIn="OnTextFocusIn(event)"
									focusOut="OnTextFocusOut(event)" width="100%" />
							</s:HGroup>
						</s:HGroup>
						<s:HGroup verticalAlign="middle" gap="15" width="80%">
							<s:Spacer width="50%" />
							<s:HGroup horizontalAlign="left" width="50%">
								<s:Label styleName="FieldDescription" text="Speed of the stir bar"/>
							</s:HGroup>
						</s:HGroup>
					</s:VGroup>
					<s:Spacer height="100%" />
				</s:VGroup>
			</s:VGroup>
		</s:VGroup>
		<s:VGroup id="_runGroup" visible="false" includeInLayout="false" width="100%" height="100%">
			<s:HGroup width="100%" horizontalAlign="center">
				<s:Label id="_runComponentName" styleName="TextLarge" />
			</s:HGroup>
			<s:Spacer height="10" />
			<s:VGroup horizontalAlign="center" verticalAlign="middle" horizontalCenter="0" verticalCenter="0" gap="15" width="100%" height="100%">
				<s:Spacer height="100%" />
				<s:HGroup verticalAlign="middle" width="80%">
					<mx:Text id="_runOutputText1" styleName="TextMedium" width="100%" />
				</s:HGroup>
				<s:HGroup verticalAlign="middle" width="80%">
					<mx:Text id="_runOutputText2" styleName="TextMedium" width="100%" />
				</s:HGroup>
				<s:HGroup horizontalAlign="center" verticalAlign="middle" width="80%">
					<s:Label text="Status:" styleName="TextMedium" />
					<mx:Text id="_runStatusText" styleName="TextMedium" width="100%" />
				</s:HGroup>
				<s:HGroup id="_timerButtons" horizontalAlign="center" verticalAlign="middle" width="80%" />
				<s:HGroup horizontalAlign="center" verticalAlign="middle" width="80%">
					<mx:UIComponent id="_runVideo" width="480" height="320" />
				</s:HGroup>
				<s:HGroup horizontalAlign="center" verticalAlign="middle" width="80%">
					<mx:Text id="_runVideoText" styleName="TextMedium" />
				</s:HGroup>
				<s:Spacer height="100%" />
			</s:VGroup>
		</s:VGroup>
	</s:VGroup>
</Views:SubviewBase>
